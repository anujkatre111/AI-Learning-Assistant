# AI Learning Assistant — Backend Working Summary

## Overview

The backend is a **Node.js/Express** REST API that powers an AI-based learning platform. Users upload PDF documents, and the system uses **Google Gemini AI** to generate flashcards, quizzes, summaries, and contextual chat responses from the document content.

---

## Tech Stack

| Technology | Purpose |
|------------|---------|
| **Express 5** | Web framework |
| **MongoDB + Mongoose** | Database & ODM |
| **JWT** | Authentication |
| **bcryptjs** | Password hashing |
| **Multer** | File uploads (PDF only) |
| **pdf-parse** | PDF text extraction |
| **Google Gemini AI** (`@google/genai`) | AI generation (flashcards, quizzes, summaries, chat) |
| **express-validator** | Request validation |

---

## Architecture

```
backend/
├── config/         # Database & Multer config
├── controllers/    # Route handlers
├── middleware/     # Auth, error handling
├── models/         # Mongoose schemas
├── routes/         # API route definitions
├── utils/          # PDF parsing, text chunking, Gemini AI service
└── uploads/        # Uploaded PDF storage
```

---

## API Routes Summary

### 1. Authentication (`/api/auth`)

| Method | Endpoint | Access | Description |
|--------|----------|--------|-------------|
| POST | `/register` | Public | Register new user (username, email, password) |
| POST | `/login` | Public | Login (email, password) → returns JWT |
| GET | `/profile` | Private | Get current user profile |
| PUT | `/profile` | Private | Update profile (username, email, profileImage) |
| POST | `/change-password` | Private | Change password (currentPassword, newPassword) |

**Auth flow:** JWT in `Authorization: Bearer <token>` header. Protected routes use `protect` middleware.

---

### 2. Documents (`/api/documents`)

| Method | Endpoint | Access | Description |
|--------|----------|--------|-------------|
| POST | `/upload` | Private | Upload PDF (form-data: `file`, `title`) |
| GET | `/` | Private | List user's documents (with flashcard & quiz counts) |
| GET | `/:id` | Private | Get single document with full chunks |
| DELETE | `/:id` | Private | Delete document |

**Document flow:**
1. PDF uploaded → stored in `uploads/documents/` with unique filename
2. Background processing: text extracted via `pdf-parse`, split into chunks (500 words, 50 overlap)
3. Document status: `processing` → `ready` or `failed`
4. Chunks used for RAG-style chat (relevant chunk retrieval)

---

### 3. Flashcards (`/api/flashcards`)

| Method | Endpoint | Access | Description |
|--------|----------|--------|-------------|
| GET | `/` | Private | List all flashcard sets for user |
| GET | `/:documentId` | Private | Get flashcards for a document |
| POST | `/:cardId/review` | Private | Mark card as reviewed |
| POST | `/:cardId/star` | Private | Toggle star/favourite on card |
| DELETE | `/:id` | Private | Delete flashcard set |

Flashcards are **generated by AI** via `/api/ai/generate-flashcards`, not created manually.

---

### 4. AI Services (`/api/ai`)

| Method | Endpoint | Access | Description |
|--------|----------|--------|-------------|
| POST | `/generate-flashcards` | Private | Generate flashcards from document |
| POST | `/generate-quiz` | Private | Generate quiz from document |
| POST | `/generate-summary` | Private | Generate document summary |
| POST | `/chat` | Private | Chat with AI about document (RAG) |
| POST | `/explain-concept` | Private | Explain a concept from document |
| GET | `/chat-history` | Private | Get chat history for a document |

**Request bodies (examples):**
- `generate-flashcards`: `{ documentId, count? }`
- `generate-quiz`: `{ documentId, numQuestions?, title? }`
- `generate-summary`: `{ documentId }`
- `chat`: `{ documentId, question }`
- `explain-concept`: `{ documentId, concept }`

**Chat / explain-concept:** Uses `findRelevantChunks()` to select top 3 chunks by keyword match, then sends them as context to Gemini.

---

### 5. Quizzes (`/api/quizzes`)

| Method | Endpoint | Access | Description |
|--------|----------|--------|-------------|
| GET | `/:documentId` | Private | List quizzes for a document |
| GET | `/quiz/:id` | Private | Get single quiz by ID |
| POST | `/quiz/:id/submit` | Private | Submit quiz answers |
| GET | `/:id/results` | Private | Get quiz results (*handler empty*) |
| DELETE | `/:id` | Private | Delete quiz (*handler empty*) |

**Submit format:** `{ answers: [{ questionIndex, selectedAnswer }, ...] }`

---

## Data Models

### User
- `username`, `email`, `password` (hashed), `profileImage`, `createdAt`

### Document
- `userId`, `title`, `fileName`, `filePath`, `fileSize`, `extractedText`, `chunks[]`, `status`, `uploadDate`, `lastAccessed`
- Chunk: `{ content, pageNumber, chunkIndex }`

### Flashcard
- `userId`, `documentId`, `cards[]`
- Card: `question`, `answer`, `difficulty`, `lastReviewed`, `reviewCount`, `isStarred`

### Quiz
- `userId`, `documentId`, `title`, `questions[]`, `userAnswers[]`, `score`, `totalQuestions`, `completedAt`
- Question: `question`, `options[4]`, `correctAnswer`, `explanation`, `difficulty`

### ChatHistory
- `userId`, `documentId`, `messages[]`
- Message: `role`, `content`, `timestamp`, `relevantChunks[]`

---

## Utilities

### `pdfParser.js`
- `extractTextFromPDF(filepath)` → `{ text, numPages, info }`

### `textChunker.js`
- `chunkText(text, chunkSize=500, overlap=50)` → chunks with `content`, `chunkIndex`, `pageNumber`
- `findRelevantChunks(chunks, query, maxChunks=5)` → keyword-scored chunks for RAG

### `geminiService.js` (Gemini 2.5 Flash Lite)
- `generateFlashcards(text, count)` → `[{ question, answer, difficulty }]`
- `generateQuiz(text, numQuestions)` → `[{ question, options, correctAnswer, explanation, difficulty }]`
- `generateSummary(text)` → summary string
- `chatWithContext(question, chunks)` → answer string
- `explainConcept(concept, context)` → explanation string

---

## Configuration

### Environment Variables
- `MONGODB_URI` — MongoDB connection string
- `JWT_SECRET` — JWT signing secret
- `JWT_EXPIRE` — Token expiry (default `7d`)
- `GEMINI_API_KEY` — Google Gemini API key
- `PORT` — Server port (default `5000`)
- `MAX_FILE_SIZE` — Max PDF size in bytes (default 10MB)

### Multer
- PDFs only, max 10MB
- Filename: `{timestamp}_{random} - {originalname}`
- Stored in `uploads/documents/`

---

## Middleware

- **`protect`** — Verifies JWT, sets `req.user`, returns 401 if invalid/expired
- **`erroHandler`** — Handles Mongoose errors (CastError, ValidationError, duplicate key), Multer limits, JWT errors

---

## Static Files

- `/uploads` — Serves files from `uploads/` (e.g. PDFs at `/uploads/documents/...`)

---

## Known Limitations / Incomplete

1. **`getQuizResults`** — Controller body is empty
2. **`deleteQuiz`** — Controller body is empty
3. **`getChatHstory`** — Route is `GET /chat-history` but controller reads `req.params.documentId`; `documentId` should be passed as query param (e.g. `?documentId=xxx`)
4. **Document delete** — Uses `document.filepath` but model stores `filePath` (URL); file deletion may fail
5. **CORS** — Typo: `methoda` instead of `methods` in `server.js`

---

## How to Run

```bash
cd backend
npm install
# Set .env with MONGODB_URI, JWT_SECRET, GEMINI_API_KEY
npm run dev   # nodemon
# or
npm start     # node server.js
```

Server runs on `http://localhost:5000` (or `PORT` from env).
